<!DOCTYPE html>
<html>
    <head>
        <title>Web Keyboard</title>
        <style type="text/css">
            body {
                font-family: "Courier New", sans-serif;
                text-align: center;
            }
            .buttons {
                font-size: 4em;
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            .button {
                line-height: 1;
                padding: 2rem;
                margin: 2rem;
                border: medium solid;
                min-height: 1em;
                min-width: 1em;
            }
            .button {
                cursor: pointer;
                user-select: none;
            }
            .remote {
                background-color: #CCC;
            }
            .local {
                color: blue;
                border-color: blue;
            }
            .state {
                font-size: 2em;
            }
        </style>
    </head>
    <body>
        <div class="buttons">
        </div>
        <div class="state">
            <span class="users">?</span> online
        </div>
        <script>
            var users = document.querySelector('.users');
            var state = document.querySelector('.state');
            var websocket = new WebSocket("ws://127.0.0.1:6789/");
            var initialized = false;
            var VERSION = 1;
            var keyMap = {
                "left": "ArrowLeft",
                "right": "ArrowRight",
                "up": "ArrowUp",
                "down": "ArrowDown",
            };
            var keys = [];
            var keyboardIndexes = {};
            var localKeyStates = [];
            function sendLocalKeyStates() {
                websocket.send(JSON.stringify(localKeyStates));
            }
            function keyDownFn(i) {
                return function(ev) {
                    localKeyStates[i] = true;
                    keys[i].classList.add("local");
                    sendLocalKeyStates();
                    return false;
                }
            }
            function keyUpFn(i) {
                return function(ev) {
                    localKeyStates[i] = false;
                    keys[i].classList.remove("local");
                    sendLocalKeyStates();
                    return false;
                }
            }
            document.addEventListener("keydown", function(ev) {
                if (ev.key in keyboardIndexes) {
                    keyDownFn(keyboardIndexes[ev.key])();
                }
            });
            document.addEventListener("keyup", function(ev) {
                if (ev.key in keyboardIndexes) {
                    keyUpFn(keyboardIndexes[ev.key])();
                }
            });
            function initKeys(keyNames) {
                var buttons = document.querySelector('.buttons');
                for (const name of keyNames) {
                    var key = document.createElement("div");
                    key.textContent = name;
                    key.classList.add("button");
                    buttons.appendChild(key);
                    var i = keys.length;
                    keys.push(key);
                    localKeyStates.push(false);
                    key.onmousedown = keyDownFn(i);
                    key.onmouseup = keyUpFn(i);
                    key.ontouchstart = keyDownFn(i);
                    key.ontouchend = keyUpFn(i);
                    if (name in keyMap) {
                        keyboardIndexes[keyMap[name]] = i;
                    } else {
                        keyboardIndexes[name] = i;
                    }
                }
                initialized = true;
            }
            function updateKeys(keyValues) {
                for (var i = 0; i < keys.length; i++) {
                    if (keyValues[i] > 0) {
                        keys[i].classList.add("remote");
                    } else {
                        keys[i].classList.remove("remote");
                    }
                }
            }
            websocket.onmessage = function (event) {
                data = JSON.parse(event.data);
                if (!initialized) {
                    if (data.version != VERSION) {
                        state.textContent = "invalid version " + data.version + "; please refresh";
                        websocket.close();
                        return;
                    }
                    initKeys(data.keys);
                } else {
                    users.textContent = (data.u + " user(s)");
                    updateKeys(data.k);
                }
            };
            websocket.onerror = websocket.onclose = function (ev) {
                state.textContent = "connection closed";
            };
        </script>
    </body>
</html>
